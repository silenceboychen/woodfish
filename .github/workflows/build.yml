name: Build and Release

# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€ tag æ—¶
on:
  push:
    tags:
      - 'v*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰æ ¼å¼çš„ tag

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
        
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm install

      # macOS éœ€è¦å¯¼å…¥å¼€å‘è€…è¯ä¹¦ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
      - name: Import Developer ID Certificate (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ  macOS ç­¾åç›¸å…³çš„é…ç½®
          # å¦‚æœæ²¡æœ‰å¼€å‘è€…è¯ä¹¦ï¼Œelectron-builder ä¼šç”Ÿæˆæœªç­¾åçš„åŒ…
          echo "Building for macOS without code signing"

      # Linux å¹³å°æ„å»º
      - name: Build for Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          # å®‰è£… Linux æ„å»ºä¾èµ–
          sudo apt-get update
          sudo apt-get install -y libnss3-dev libatk-bridge2.0-dev libdrm2 libgtk-3-dev libgbm-dev
          npm run dist
        env:
          CI: true

      # Windows å¹³å°æ„å»º
      - name: Build for Windows
        if: matrix.os == 'windows-latest'
        run: npm run dist
        env:
          CI: true

      # macOS å¹³å°æ„å»º
      - name: Build for macOS
        if: matrix.os == 'macos-latest'
        run: npm run dist
        env:
          CI: true
          # å¦‚æœè¦ç¦ç”¨å…¬è¯ï¼Œå¯ä»¥è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡
          CSC_IDENTITY_AUTO_DISCOVERY: false

      # ä¸Šä¼ æ„å»ºäº§ç‰©
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-build
          path: |
            dist/*.dmg
            dist/*.zip
            dist/*.exe
            dist/*.AppImage
            dist/*.deb
            dist/*.tar.gz
          retention-days: 7

  # åˆ›å»º GitHub Release
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      # æ£€å‡ºä»£ç 
      - name: Checkout code
        uses: actions/checkout@v4

      # ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      # æ•´ç†æ–‡ä»¶ç»“æ„
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          # å¤åˆ¶æ‰€æœ‰æ„å»ºäº§ç‰©åˆ°ç»Ÿä¸€ç›®å½•
          find ./artifacts -type f \( -name "*.dmg" -o -name "*.zip" -o -name "*.exe" -o -name "*.AppImage" -o -name "*.deb" \) -exec cp {} ./release-assets/ \;
          ls -la ./release-assets/

      # è·å– tag ç‰ˆæœ¬å·
      - name: Get tag version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      # ç”Ÿæˆå‘å¸ƒè¯´æ˜
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release_notes.md << EOF
          ## ğŸ‰ æœ¨é±¼åº”ç”¨ ${{ steps.get_version.outputs.VERSION }}

          ### ğŸ“¦ ä¸‹è½½é“¾æ¥
          
          **macOS:**
          - \`.dmg\` - é€‚ç”¨äº macOS çš„å®‰è£…åŒ…
          - \`.zip\` - ä¾¿æºç‰ˆæœ¬
          
          **Windows:**
          - \`.exe\` - Windows å®‰è£…ç¨‹åº
          - \`-portable.exe\` - ä¾¿æºç‰ˆæœ¬
          
          **Linux:**
          - \`.AppImage\` - é€šç”¨ Linux åº”ç”¨
          - \`.deb\` - Ubuntu/Debian åŒ…
          
          ### ğŸ”§ å®‰è£…è¯´æ˜
          
          **macOS:** ä¸‹è½½ .dmg æ–‡ä»¶ï¼ŒåŒå‡»å®‰è£…
          **Windows:** ä¸‹è½½ .exe æ–‡ä»¶ï¼Œè¿è¡Œå®‰è£…
          **Linux:** 
          - AppImage: ä¸‹è½½åæ·»åŠ æ‰§è¡Œæƒé™ \`chmod +x *.AppImage\`
          - Debian: \`sudo dpkg -i *.deb\`
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - macOS ç‰ˆæœ¬æœªç» Apple å…¬è¯ï¼Œé¦–æ¬¡è¿è¡Œæ—¶å¯èƒ½éœ€è¦åœ¨ç³»ç»Ÿåå¥½è®¾ç½®ä¸­å…è®¸ï¼Œå¦‚å®‰è£…åæ— æ³•ä½¿ç”¨ï¼Œè¯·å°è¯•åœ¨ç»ˆç«¯ä¸­è¿è¡Œ \`xattr -d com.apple.quarantine /Applications/æœ¨é±¼.app\`
          - Windows ç‰ˆæœ¬å¯èƒ½è§¦å‘ SmartScreen è­¦å‘Šï¼Œé€‰æ‹©"ä»è¦è¿è¡Œ"å³å¯
          
          ---
          
          æ„Ÿè°¢ä½¿ç”¨æœ¨é±¼åº”ç”¨ï¼ğŸ™
          EOF
          
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # åˆ›å»º Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: æœ¨é±¼åº”ç”¨ ${{ steps.get_version.outputs.VERSION }}
          body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
          files: ./release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æ¸…ç†ä»»åŠ¡
  cleanup:
    name: Cleanup
    needs: [build, release]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Clean up artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            macos-latest-build
            ubuntu-latest-build
            windows-latest-build
          failOnError: false 